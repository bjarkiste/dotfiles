#!/usr/bin/env bash
set -euo pipefail

usage() {
  echo "usage:"
  echo "  tiltd up <project> [-b]"
  echo "  tiltd down"
  echo "  tiltd restart"
  echo "  tiltd status"
  echo "  tiltd logs"
  exit 2
}

running_unit() {
  local u
  u="$(
    systemctl --user list-units --type=service --state=running 'tilt@*.service' \
      --no-legend --no-pager 2>/dev/null \
    | awk '{print $1}' \
    | head -n1
  )"

  if [[ -n "${u:-}" ]]; then
    echo "$u"
    return 0
  else
    return 1
  fi
}

project_name() {
  local u="$1"
  u="${u#tilt@}"
  u="${u%.service}"
  echo "$u"
}

open_browser=0

cmdarg=()
for arg in "$@"; do
  if [[ "$arg" == -* ]]; then
    case "$arg" in
      -b|--browser) open_browser=1 ;;
      *) echo "tiltd: unknown option: $arg"; exit 2 ;;
    esac
  else
    cmdarg+=( "$arg" )
  fi
done
set -- "${cmdarg[@]}"

cmd="${1:-}"
case "$cmd" in
  up)
    project="${2:-}"
    [[ -z "$project" ]] && usage

    if u="$(running_unit)"; then
      echo "tiltd: already running: $(project_name "$u")"
      exit 1
    fi

    systemctl --user start "tilt@${project}.service"

    if (( open_browser == 1 )); then
      xdg-open http://localhost:10350 >/dev/null 2>&1 &
    fi
    ;;
  down)
    if ! u="$(running_unit)"; then
      echo "tiltd: no running Tilt daemon"
      exit 0
    fi
    systemctl --user stop "$u"
    ;;
  restart)
    if ! u="$(running_unit)"; then
      echo "tiltd: no running Tilt daemon"
      exit 1
    fi
    systemctl --user restart "$u"
    ;;
  status)
    if ! u="$(running_unit)"; then
      echo "tiltd: no running Tilt daemon"
      exit 0
    fi
    systemctl --user status "$u"
    ;;
  logs)
    if ! u="$(running_unit)"; then
      echo "tiltd: no running Tilt daemon"
      exit 1
    fi
    journalctl --user -u "$u" -f
    ;;
  *)
    usage
    ;;
esac
